
const express = require('express');
const path = require('path');
const handlebars = require('express-handlebars')
const router = express.Router()
const port = 8080
const conn = require('./db/conn');
const Teste = require('./models/cad')
const Aluno = require('./models/aluno')
const app = express()


//configuração do template engine
app.engine('handlebars', handlebars.engine({ defaultLayout: 'main'}));
app.set('views', path.join(__dirname,'views'))
app.set('view engine','handlebars')
app.use(express.urlencoded({extended: 'false'}))
router.use(express.json())

//arquivos estático
app.use(express.static("public"))
router.use(express.urlencoded({extended:true})) 

app.get('/', (req,res)=>{
    res.render('landing')
})


app.get('/add/cadastro', (req,res)=>{
    res.render('login')
})

app.get('/add/dash',(req,res)=>{
    res.render('dash')
})

app.get('/treino',(req,res)=>{
    res.render('treino')
})


//CADASTRO E AUTENTICAÇÃO
app.post('/add/cadastro', async (req,res) => {
   //INSERÇÃO
    const nome = req.body.nome
    const email = req.body.email
    const senha = req.body.senha

    console.log(req.body)

    await Teste.create({nome,email,senha})

    res.render('dash')
    ////////////////////////////////////////////
    
    //AUTENTICAÇÃO
    const user = await Teste.findOne({
        attributes:['id','nome','email','senha'],
        where:{
            email:req.body.email,          
        }
    });

    if (user === null){
        res.redirect('login')
        console.log('FALHA')
    }else{
        res.render('dash')
       console.log('CADASTRADO')
    }
    
    const senhacad = await Teste.findOne({
        attributes:['id','nome','email','senha'],
        where:{
            senhacad:req.body.senha
        }
    });

    if(senhacad === null){
        res.redirect('login')
        console.log('INVÁLIDA')
    }else{
        res.render('dash')
        console.log('CADASTRADO')
    }

})

//

app.get('/login', (req,res) =>{
    res.render('login')
})

app.post('/login', async(req,res) =>{
    const user = await Teste.findOne({
        attributes:['id','nome','email','senha'],
        where:{
            email:req.body.email,
            
        }
    });

    if (user === null){
        res.redirect('login')
        console.log('FALHA')
    }else{
        res.render('dash')
       console.log('CADASTRADO')
    }
    
    const senha = await Teste.findOne({
        attributes:['id','nome','email','senha'],
        where:{
            senha:req.body.senha
        }
    });

    if(senha === null){
        res.redirect('login')
        console.log('INVÁLIDA')
    }else{
        res.render('dash')
        console.log('CADASTRADO')
    }

})




conn.sync().then(()=>{
    app.listen(port)
}).catch((error)=> console.log(error))














































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































